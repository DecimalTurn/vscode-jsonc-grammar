name: TextMate Grammar Screenshot

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  screenshot:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install TextMate
        run: brew install --cask textmate

      - name: Install Monokai dark theme for TextMate
        run: |
          echo "Installing Monokai dark theme for TextMate..."
          mkdir -p ~/Library/Application\ Support/TextMate/Themes
          curl -fsSL -o ~/Library/Application\ Support/TextMate/Themes/Monokai.tmTheme \
            https://raw.githubusercontent.com/textmate/monokai.tmbundle/refs/heads/master/Themes/Monokai.tmTheme
          echo "Monokai.tmTheme installed at ~/Library/Application Support/TextMate/Themes/Monokai.tmTheme"

      - name: Configure TextMate dark theme
        run: |
          echo "Configuring TextMate to use a dark theme..."
          echo "Searching for Monokai theme in /Applications/TextMate.app and ~/Library/Application Support/TextMate/Themes..."
          THEME_PATH=$(find /Applications/TextMate.app ~/Library/Application\ Support/TextMate/Themes 2>/dev/null -name '*Monokai*.tmTheme' -print -quit || true)
          echo "THEME_PATH after Monokai search: $THEME_PATH"
          if [ -z "$THEME_PATH" ]; then
            echo "No Monokai theme found, searching for any dark theme..."
            THEME_PATH=$(find /Applications/TextMate.app ~/Library/Application\ Support/TextMate/Themes 2>/dev/null -name '*.tmTheme' | grep -i dark | head -n1)
            echo "THEME_PATH after dark theme search: $THEME_PATH"
          fi
          if [ -z "$THEME_PATH" ]; then
            echo "No dark theme found, searching for any available theme..."
            THEME_PATH=$(find /Applications/TextMate.app ~/Library/Application\ Support/TextMate/Themes 2>/dev/null -name '*.tmTheme' | head -n1)
            echo "THEME_PATH after any theme search: $THEME_PATH"
          fi
          if [ -n "$THEME_PATH" ]; then
            THEME_NAME=$(basename "$THEME_PATH" .tmTheme)
            echo "Found theme: $THEME_NAME at $THEME_PATH"
            echo "Attempting to extract UUID from $THEME_PATH..."
            THEME_UUID=$(plutil -extract uuid xml1 -o - "$THEME_PATH" 2>/dev/null | grep -oE '[A-F0-9\-]{36}')
            echo "THEME_UUID: $THEME_UUID"
            if [ -n "$THEME_UUID" ]; then
              echo "Setting themeUUID in defaults..."
              defaults write com.macromates.TextMate themeUUID "$THEME_UUID"
              echo "Set TextMate theme to $THEME_NAME ($THEME_UUID)"
            else
              echo "Could not extract theme UUID from $THEME_PATH. Trying AppleScript by name."
              osascript -e "tell application \"TextMate\" to activate" -e "tell application \"System Events\" to tell process \"TextMate\" to keystroke \"T\" using {command down, option down}" -e "delay 1" -e "tell application \"System Events\" to keystroke '$THEME_NAME'" -e "delay 1" -e "tell application \"System Events\" to key code 36" || echo "AppleScript theme selection failed."
            fi
          else
            echo "No theme found in TextMate installation after all search attempts."
          fi
          echo "TextMate dark theme configured"
          sleep 2

      - name: Convert JSON to PLIST
        run: |
          echo "Converting syntaxes/JSONC.tmLanguage.json to JSONC.plist..."
          plutil -convert xml1 syntaxes/JSONC.tmLanguage.json -o JSONC.plist
          
          # Display the resulting plist file content
          # echo "Content of the generated JSONC.plist file:"
          # cat JSONC.plist

      - name: Open file in TextMate (before installing grammar)
        run: |
          echo "Opening TextMate with sample.jsonc (pre-grammar)..."
          open -a "/Applications/TextMate.app" sample.jsonc
          sleep 5

      - name: Create JSONC.tmbundle and install from repo
        run: |
          mkdir -p ~/Library/Application\ Support/TextMate/Bundles/JSONC.tmbundle/Syntaxes
          mkdir -p ~/Library/Application\ Support/TextMate/Bundles/JSONC.tmbundle/Preferences
          
          # Copy the local grammar file from the repo to the bundle
          cp JSONC.plist ~/Library/Application\ Support/TextMate/Bundles/JSONC.tmbundle/Syntaxes/
          
          # Create info.plist with proper bundle information
          cat <<EOF > ~/Library/Application\ Support/TextMate/Bundles/JSONC.tmbundle/info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>contactEmailRot13</key>
            <string>admin@example.com</string>
            <key>contactName</key>
            <string>JSONC Bundle</string>
            <key>description</key>
            <string>Support for JSONC configuration files</string>
            <key>name</key>
            <string>JSONC</string>
            <key>uuid</key>
            <string>$(uuidgen)</string>
          </dict>
          </plist>
          EOF
          
          # Print some debug info
          echo "Created JSONC bundle at: ~/Library/Application Support/TextMate/Bundles/JSONC.tmbundle"
          ls -la ~/Library/Application\ Support/TextMate/Bundles/JSONC.tmbundle/Syntaxes/
            
          
      - name: Reload TextMate bundles
        run: |
          echo "Reloading TextMate bundles..."
          echo "The following line usually returns an error, but bundles are still reloaded"
          osascript reload_bundles.scpt || echo "⚠️ AppleScript error encountered"
          
          # Alternative reload method
          pkill -f TextMate || true
          sleep 2
          
      - name: Reopen TextMate with sample.jsonc (should reload bundles)
        run: |
          echo "Restarting TextMate to ensure grammar takes effect..."
          pkill -f TextMate || true
          sleep 2
          open -a "/Applications/TextMate.app" sample.jsonc
          sleep 5

      - name: List installed bundles
        run: |
          echo "Installed bundles:"
          ls -l ~/Library/Application\ Support/TextMate/Bundles || echo "No bundles found"

      - name: Take screenshot after grammar install
        run: |
          mkdir -p screenshots
          screencapture -x screenshots/textmate.png

      - name: Upload screenshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: textmate-jsonc-syntax-screenshots
          path: screenshots/*.png